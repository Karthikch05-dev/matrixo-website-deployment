// ============================================
// FIRESTORE SECURITY RULES FOR NOTIFICATIONS
// ============================================
// Add these rules to your firestore.rules file

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ... existing rules ...
    
    // Notifications Collection
    match /notifications/{notificationId} {
      
      // Helper function to check if user is authenticated
      function isAuthenticated() {
        return request.auth != null;
      }
      
      // Helper function to get employee ID from auth
      function getEmployeeId() {
        // Assuming employee ID is stored in custom claims or matches auth.uid
        // Adjust based on your auth setup
        return request.auth.uid;
      }
      
      // Read: Users can only read notifications addressed to them
      allow read: if isAuthenticated() && 
        resource.data.recipientId == getEmployeeId();
      
      // Create: Authenticated users can create notifications
      allow create: if isAuthenticated() &&
        request.resource.data.senderId == getEmployeeId() &&
        request.resource.data.recipientId != null &&
        request.resource.data.type in ['task', 'discussion', 'calendar'] &&
        request.resource.data.read == false;
      
      // Update: Users can only update their own notifications (mark as read)
      allow update: if isAuthenticated() && 
        resource.data.recipientId == getEmployeeId() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Delete: Only allow deletion of own old notifications (optional - enable if needed)
      // allow delete: if isAuthenticated() && 
      //   resource.data.recipientId == getEmployeeId();
      
      // For now, no deletion allowed
      allow delete: if false;
    }
  }
}

// ============================================
// ALTERNATIVE: More Permissive Rules (Development)
// ============================================
// Use these rules during development/testing only
// DO NOT use in production without proper authentication

/*
match /notifications/{notificationId} {
  // Allow all authenticated users to read/write (development only)
  allow read, write: if request.auth != null;
}
*/

// ============================================
// NOTES
// ============================================
/*
1. Adjust getEmployeeId() based on your authentication setup:
   - If using Firebase Auth with employee ID as uid: return request.auth.uid
   - If using custom claims: return request.auth.token.employeeId
   - If using Firestore lookup: You may need a different approach

2. Consider adding rate limiting for notification creation:
   
   function isNotSpamming() {
     return request.time > resource.data.createdAt + duration.value(1, 's');
   }

3. For admin users who can create notifications for all:
   
   function isAdmin() {
     return request.auth.token.role == 'admin';
   }
   
   allow create: if isAuthenticated() && (
     request.resource.data.senderId == getEmployeeId() ||
     isAdmin()
   );

4. To allow users to delete old read notifications:
   
   allow delete: if isAuthenticated() && 
     resource.data.recipientId == getEmployeeId() &&
     resource.data.read == true;
*/
