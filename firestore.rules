rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // ================================================
    // PERSONAL TODOS COLLECTION (NEW)
    // ================================================
    match /personalTodos/{todoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // EMPLOYEES COLLECTION
    // ================================================
    match /Employees/{employeeId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ================================================
    // ATTENDANCE COLLECTION
    // ================================================
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // HOLIDAYS COLLECTION
    // ================================================
    match /holidays/{holidayId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // CALENDAR EVENTS COLLECTION
    // ================================================
    match /calendarEvents/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // TASKS COLLECTION
    // ================================================
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // DISCUSSIONS COLLECTION
    // ================================================
    match /discussions/{discussionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // ACTIVITY LOGS COLLECTION
    // ================================================
    match /activityLogs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // NOTIFICATIONS COLLECTION (legacy)
    // ================================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // USER NOTIFICATIONS COLLECTION (per-user)
    // ================================================
    match /userNotifications/{notificationId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // VIBECODE REGISTRATIONS COLLECTION
    // ================================================
    match /vibecode_registrations/{registrationId} {
      // Allow authenticated users to create registrations
      allow create: if isAuthenticated();
      // Allow authenticated users to read registrations (needed for duplicate check query)
      allow read: if isAuthenticated();
      // Only admins can update or delete
      allow update, delete: if false;
    }

    // ================================================
    // USER PROFILES COLLECTION
    // ================================================
    match /UserProfiles/{userId} {
      // Users can only read their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Users can create their own profile (once)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Users can update their own profile (restricted fields enforced in app)
      allow update: if isAuthenticated() && request.auth.uid == userId;
      // Users cannot delete profiles
      allow delete: if false;
    }

    // ================================================
    // CAREERS SYSTEM - ROLES COLLECTION
    // ================================================
    // Helper function to check if user is an employee
    function isEmployee() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/Employees/$(request.auth.uid));
    }

    match /roles/{roleId} {
      // Anyone can read roles (public careers page reads open roles, employees can read all)
      allow read: if true;
      // Only employees can create, update, and delete roles
      allow write: if isEmployee();
    }

    // ================================================
    // CAREERS SYSTEM - APPLICATIONS COLLECTION
    // ================================================
    match /applications/{applicationId} {
      // Anyone can create an application (public apply)
      allow create: if true;
      // Only employees can read and update applications
      allow read, update: if isEmployee();
      // No one can delete applications
      allow delete: if false;
    }

    // ================================================
    // HIDDEN MEETINGS COLLECTION (admin-only write)
    // ================================================
    match /hiddenMeetings/{meetingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // REMOVED MEETINGS COLLECTION (per-user removal)
    // ================================================
    match /removedMeetings/{meetingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // MEETING TASK STATUS COLLECTION
    // ================================================
    match /meetingTaskStatus/{taskId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // PUSH SUBSCRIPTIONS COLLECTION (Web Push)
    // ================================================
    match /pushSubscriptions/{subscriptionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // MEETING NOTIFIED COLLECTION (auto-notification tracking)
    // ================================================
    match /meetingNotified/{meetingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // MEETING CUSTOM TASKS COLLECTION (admin-added tasks)
    // ================================================
    match /meetingCustomTasks/{taskId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ================================================
    // LEAVE REQUESTS COLLECTION
    // ================================================
    match /leaveRequests/{requestId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
  }
}
